name: Ultimate-Cloud-PC-Robanik-Fixed
on: 
  workflow_dispatch:
    inputs:
      authcode:
        description: 'Command from Google Remote Desktop'
        required: true
      pincode:
        description: 'PIN (6 digits)'
        required: true
        default: '123456'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Persistence & Setup
      shell: powershell
      run: |
        # Включаем звук
        Set-Service -Name "Audiosrv" -StartupType Automatic
        Start-Service -Name "Audiosrv"
        
        # Установка софта (игнорируем ошибки Discord, он капризный)
        Write-Host "Installing Soft..."
        choco install googlechromeremotedesktop discord vb-audio-virtual-cable -y --ignore-checksums || Write-Host "Soft install warning"

    - name: Launch PC
      shell: powershell
      env:
        # Передаем код через переменную окружения, чтобы кавычки не ломались
        GOOGLE_AUTH_CODE: ${{ github.event.inputs.authcode }}
      run: |
        # Проверяем наличие кода
        if (-not $env:GOOGLE_AUTH_CODE) {
          Write-Error "Auth Code is missing! Please paste the command."
          exit 1
        }

        # Фикс Discord
        Write-Host "Fixing Discord..."
        $discordExe = Get-ChildItem -Path "$env:LOCALAPPDATA\Discord\app-*\Discord.exe" | Select-Object -First 1
        if ($discordExe) {
            Start-Process $discordExe.FullName -ArgumentList "--squirrel-firstrun"
        }

        # Запуск RDP через вызов переменной
        Write-Host "Starting Remote Desktop..."
        Invoke-Expression $env:GOOGLE_AUTH_CODE --pin=${{ github.event.inputs.pincode }}

    - name: Keep-Alive
      shell: powershell
      run: |
        Write-Host "=== PC RUNNING ==="
        $i = 0
        while ($true) {
          $i++
          if ($i % 5 -eq 0) { 
            Write-Host "Still alive: $i min"
            $wsh = New-Object -ComObject WScript.Shell
            $wsh.SendKeys('{SCROLLLOCK}')
          }
          if (Test-Path "C:\stop.txt") { break }
          Start-Sleep -Seconds 60
        }
