name: Ultimate-Cloud-PC-Robanik-Edition
on: 
  workflow_dispatch:
    inputs:
      authcode:
        description: 'Command from Google Remote Desktop (PowerShell)'
        required: true
      pincode:
        description: 'PIN (6 digits)'
        required: true
        default: '123456'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1. Restore Data
    - name: Restore Persistence Data
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Roaming\discord
          ~\AppData\Local\discord
          ~\AppData\Local\Google\Chrome Remote Desktop
        key: pc-data-${{ github.run_id }}
        restore-keys: |
          pc-data-

    # 2. System & Audio Setup
    - name: System & Audio Setup
      shell: powershell
      run: |
        # Audio Service Enable
        Set-Service -Name "Audiosrv" -StartupType Automatic
        Start-Service -Name "Audiosrv"
        
        # Registry Fix for RDP Audio
        $regPath = "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
        Set-ItemProperty -Path $regPath -Name "fDisableAudioCapture" -Value 0
        Set-ItemProperty -Path $regPath -Name "fDisableAudio" -Value 0
        
        # Install Software
        Write-Host "Installing Software: CRD, Discord, VAC..."
        choco install googlechromeremotedesktop discord vb-audio-virtual-cable -y

    # 3. Discord Fix & RDP Launch
    - name: Launch Remote Desktop
      shell: powershell
      run: |
        if (-not "${{ github.event.inputs.authcode }}") {
          Write-Error "Auth Code is empty!"
          exit 1
        }

        # Fix Discord path and run
        Write-Host "Configuring Discord..."
        $discordExe = Get-ChildItem -Path "$env:LOCALAPPDATA\Discord\app-*\Discord.exe" | Select-Object -First 1
        if ($discordExe) {
            Start-Process $discordExe.FullName -ArgumentList "--squirrel-firstrun"
        }

        # Run Google RDP Command
        Write-Host "Starting Google Remote Desktop..."
        try {
            ${{ github.event.inputs.authcode }} --pin=${{ github.event.inputs.pincode }}
        } catch {
            Write-Host "Warning: RDP command failed, but continuing..."
        }

    # 4. Keep-Alive Loop
    - name: Keep-Alive Loop
      shell: powershell
      run: |
        $minutes = 0
        Write-Host "==============================================="
        Write-Host "PC STARTED SUCCESSFULLY!"
        Write-Host "To save data, create C:\stop.txt file"
        Write-Host "==============================================="
        
        while ($true) {
          $minutes++
          if ($minutes % 5 -eq 0) {
            $wsh = New-Object -ComObject WScript.Shell
            $wsh.SendKeys('{SCROLLLOCK}')
            Write-Host "Session active: $minutes min."
          }
          if (Test-Path "C:\stop.txt") {
            Write-Host "Stop file detected. Saving cache and exiting..."
            break
          }
          Start-Sleep -Seconds 60
        }
