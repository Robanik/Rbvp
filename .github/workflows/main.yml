name: Ultimate-RDP-Ngrok-Fixed-V4
on: 
  workflow_dispatch:
    inputs:
      ngrok_token:
        description: 'Your Ngrok Authtoken'
        required: true
      pincode:
        description: 'Set Windows Password'
        required: true
        default: 'Robanik123!'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: System Setup
      shell: powershell
      run: |
        # Ставим пароль
        $Password = ConvertTo-SecureString "${{ github.event.inputs.pincode }}" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $Password
        
        # Включаем звук и RDP
        Set-Service -Name "Audiosrv" -StartupType Automatic
        Start-Service -Name "Audiosrv"
        $ts = "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
        Set-ItemProperty -Path $ts -Name "fDisableAudio" -Value 0
        Set-ItemProperty -Path $ts -Name "fDisableAudioCapture" -Value 0
        (Get-WmiObject Win32_TerminalServiceSetting -Namespace root\cimv2\TerminalServices).SetAllowTSConnections(1,1)

    - name: Install Ngrok via Script
      shell: powershell
      run: |
        # Официальный способ установки Ngrok без прямых ссылок
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://ngrok-agent.s3.amazonaws.com/ngrok.ps1'))
        
        # Качаем Дискорд
        Invoke-WebRequest "https://discord.com/api/download?platform=win" -OutFile "DiscordSetup.exe"
        Start-Process "DiscordSetup.exe" -ArgumentList "/S"

    - name: Start Tunnel
      shell: powershell
      run: |
        # После установки скриптом ngrok доступен сразу
        ngrok config add-authtoken ${{ github.event.inputs.ngrok_token }}
        Start-Process ngrok -ArgumentList "tcp 3389"
        
        Write-Host "Waiting for address..."
        $found = $false
        for ($i=0; $i -lt 15; $i++) {
            Start-Sleep -Seconds 5
            try {
                $tunnels = Invoke-RestMethod http://localhost:4040/api/tunnels
                $address = $tunnels.tunnels.public_url -replace 'tcp://', ''
                if ($address) {
                    Write-Host "=========================================="
                    Write-Host "SUCCESS! CONNECT NOW:"
                    Write-Host "ADDRESS: $address"
                    Write-Host "USER: runneradmin"
                    Write-Host "PASS: ${{ github.event.inputs.pincode }}"
                    Write-Host "=========================================="
                    $found = $true
                    break
                }
            } catch { Write-Host "Checking Ngrok status... ($i)" }
        }
        
        if (!$found) { Write-Error "Failed to get address. Check your token!" }

    - name: Keep Alive
      run: |
        while ($true) {
          Write-Host "PC is Running... $(Get-Date)"
          Start-Sleep -Seconds 60
        }
