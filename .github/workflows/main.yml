name: Robanik-Ultimate-NoNgrok-Fixed
on: 
  workflow_dispatch:
    inputs:
      auth_key:
        description: 'Вставь Auth Key из Tailscale'
        required: true
      pincode:
        description: 'Пароль для RDP'
        required: true
        default: 'Robanik123!'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Setup System (Fixed)
      run: |
        # Установка пароля
        $Password = ConvertTo-SecureString "${{ github.event.inputs.pincode }}" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $Password
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runneradmin"
        
        # Включаем RDP через реестр (вместо WMI)
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        
        # Звук
        Set-Service -Name "Audiosrv" -StartupType Automatic
        Start-Service -Name "Audiosrv"

    - name: Install Tailscale & Discord
      run: |
        curl -L -o tailscale.msi https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi
        Start-Process msiexec.exe -ArgumentList '/i tailscale.msi /qn /norestart' -Wait
        curl -L -o ds.exe "https://discord.com/api/download?platform=win"
        Start-Process ds.exe -ArgumentList "/S"

    - name: Connect to Mesh
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ github.event.inputs.auth_key }} --hostname=robanik-cloud

    - name: Ready
      run: |
        Write-Host "============================="
        Write-Host "PC IS READY!"
        Write-Host "NAME: robanik-cloud"
        Write-Host "USER: runneradmin"
        Write-Host "PASS: ${{ github.event.inputs.pincode }}"
        Write-Host "============================="
        while($true){ Start-Sleep 60 }
