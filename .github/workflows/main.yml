name: Robanik-Ultimate-NoNgrok
on: 
  workflow_dispatch:
    inputs:
      auth_key:
        description: 'Вставь Auth Key из Tailscale'
        required: true
      pincode:
        description: 'Пароль для RDP'
        required: true
        default: 'Robanik123!'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Setup System
      run: |
        $Password = ConvertTo-SecureString "${{ github.event.inputs.pincode }}" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $Password
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runneradmin"
        (Get-WmiObject Win32_TerminalServiceSetting -Namespace root\cimv2\TerminalServices).SetAllowTSConnections(1,1)
        Set-Service -Name "Audiosrv" -StartupType Automatic
        Start-Service -Name "Audiosrv"

    - name: Install Tailscale & Discord
      run: |
        # Ставим Tailscale через официальный установщик
        curl -L -o tailscale.msi https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi
        Start-Process msiexec.exe -ArgumentList '/i tailscale.msi /qn /norestart' -Wait
        
        # Дискорд в фоне
        curl -L -o ds.exe "https://discord.com/api/download?platform=win"
        Start-Process ds.exe -ArgumentList "/S"

    - name: Connect to Mesh
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ github.event.inputs.auth_key }} --hostname=robanik-cloud

    - name: Keep Alive
      run: |
        Write-Host "============================="
        Write-Host "PC IS READY!"
        Write-Host "NAME: robanik-cloud"
        Write-Host "USER: runneradmin"
        Write-Host "PASS: ${{ github.event.inputs.pincode }}"
        Write-Host "============================="
        while($true){ Start-Sleep 60 }
