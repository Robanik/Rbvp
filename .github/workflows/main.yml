name: Ultimate-Cloud-PC-Robanik-Edition
on: 
  workflow_dispatch:
    inputs:
      authcode:
        description: 'Вставь ПОЛНУЮ команду из Google Remote Desktop (Windows PowerShell)'
        required: true
      pincode:
        description: 'ПИН (минимум 6 цифр)'
        required: true
        default: '123456'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1. Кэширование данных (Discord, Chrome Remote Desktop)
    - name: Restore Persistence Data
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Roaming\discord
          ~\AppData\Local\discord
          ~\AppData\Local\Google\Chrome Remote Desktop
        key: pc-data-${{ github.run_id }}
        restore-keys: |
          pc-data-

    # 2. Подготовка системы и Аудио
    - name: System & Audio Setup
      shell: powershell
      run: |
        # Включаем службу звука
        Set-Service -Name "Audiosrv" -StartupType Automatic
        Start-Service -Name "Audiosrv"
        
        # Разрешаем захват и передачу звука через RDP в реестре
        $registryPath = "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
        Set-ItemProperty -Path $registryPath -Name "fDisableAudioCapture" -Value 0
        Set-ItemProperty -Path $registryPath -Name "fDisableAudio" -Value 0
        
        # Устанавливаем софт: RDP, Discord и Виртуальный аудио-кабель
        Write-Host "Устанавливаю софт через Chocolatey..."
        choco install googlechromeremotedesktop discord vb-audio-virtual-cable -y

    # 3. Фикс Discord и Запуск RDP
    - name: Launch Remote Desktop
      shell: powershell
      run: |
        # Проверка на пустой ввод
        if (-not "${{ github.event.inputs.authcode }}") {
          Write-Error "Ошибка: Поле Auth Code пустое! Скопируй команду с сайта Google."
          exit 1
        }

        # Фикс ошибки Discord (первый запуск)
        Write-Host "Принудительная настройка Discord..."
        $discordExe = Get-ChildItem -Path "$env:LOCALAPPDATA\Discord\app-*\Discord.exe" | Select-Object -First 1
        if ($discordExe) {
            Start-Process $discordExe.FullName -ArgumentList "--squirrel-firstrun"
        }

        # Запуск Google Remote Desktop
        Write-Host "Запускаю удаленный рабочий стол..."
        try {
            ${{ github.event.inputs.authcode }} --pin=${{ github.event.inputs.pincode }}
        } catch {
            Write-Host "Предупреждение: Ошибка при выполнении команды Google, но продолжаем..."
        }

    # 4. Бесконечный цикл с защитой от АФК и сохранением данных
    - name: Keep-Alive Loop
      shell: powershell
      run: |
        $minutes = 0
        Write-Host "==============================================="
        Write-Host "ПОБЕДА! ПК ЗАПУЩЕН."
        Write-Host "Инструкция по сохранению данных:"
        Write-Host "Чтобы сохранить настройки Discord, создай файл C:\stop.txt"
        Write-Host "==============================================="
        
        while ($true) {
          $minutes++
          
          # Анти-АФК: имитируем нажатие клавиши ScrollLock каждые 5 минут
          if ($minutes % 5 -eq 0) {
            $wsh = New-Object -ComObject WScript.Shell
            $wsh.SendKeys('{SCROLLLOCK}')
            Write-Host "Активность подтверждена. Прошло $minutes мин."
          }

          # Проверка триггера на сохранение (кэширование)
          if (Test-Path "C:\stop.txt") {
            Write-Host "Файл stop.txt найден! Завершаю работу для сохранения кэша..."
            break
          }

          Start-Sleep -Seconds 60
        }
